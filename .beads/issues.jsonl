{"id":"ai-configs-464","title":"Epic: Multi-Model Review Gate System","description":"Implement ralph-wiggum pattern for multi-model review gates.\n\n## Overview\n- Automatically validates artifacts from /healthcheck, /architecture-review, /bd-breakdown\n- Spawns Claude, Codex, Gemini reviewers in parallel (read-only)\n- Blocks session stop until consensus or user decision\n- Manual trigger via /review-gate command\n\n## Architecture\nSingle Stop hook handles entire lifecycle:\n1. Allowlist resolve command (prevent deadlock)\n2. Detect artifact + spawn reviewers if needed\n3. Track completion via sentinel files\n4. Calculate consensus and present results\n5. Block until user decides PROCEED/REVISE/ABORT\n\n## Acceptance Criteria\n- Review gate can be triggered manually via /review-gate\n- Review gate automatically triggers when .review/latest.md exists\n- User can PROCEED/REVISE/ABORT after seeing consensus\n\n## Source\nPlan: ~/.claude/plans/unified-tinkering-token.md\nReviewed by: Codex, Gemini","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-27T19:42:45.007967311Z","updated_at":"2025-12-27T19:42:45.007967311Z"}
{"id":"ai-configs-464.1","title":"Create review-gate-spawn script","description":"Core script that spawns 3 reviewers (Claude, Codex, Gemini) in background.\n\n## Primary Files\n- bin/review-gate-spawn (create)\n\n## Context\n- Creates `.review/gate-state.json` with status tracking\n- Must use `nohup setsid` for process survival (critical fix from review)\n- Uses sentinel files (.done) instead of PIDs for completion tracking\n- Must handle absolute paths via $CLAUDE_PROJECT_DIR or git root\n\n## Implementation Details\n\nProcess survival pattern:\n```bash\nnohup setsid claude -p --allowedTools \"\" \"$PROMPT\" \u003e .review/reviews/claude.json 2\u003e\u00261 \u0026\n```\n\nSentinel file pattern:\n```bash\n(claude ... \u003e .review/reviews/claude.json \u0026\u0026 touch .review/reviews/claude.done) \u0026\n```\n\nPath resolution:\n```bash\nPROJECT_ROOT=\"${CLAUDE_PROJECT_DIR:-$(git rev-parse --show-toplevel 2\u003e/dev/null || pwd)}\"\n```\n\nPreflight check - required: jq, claude; optional: codex, gemini (warn and skip if missing)\n\n## Acceptance Criteria\n- [ ] Script accepts artifact path as argument\n- [ ] Creates .review/reviews/ directory\n- [ ] Spawns available reviewers (skip missing CLIs with warning)\n- [ ] Creates gate-state.json with created_at timestamp\n- [ ] Background processes survive script exit\n- [ ] .done sentinel files created on completion\n- [ ] Cleans up old state at start\n\n## Test Plan\n- Run `./bin/review-gate-spawn test.md` manually\n- Verify .review/gate-state.json created with correct schema\n- Verify reviewer processes run in background\n- Verify .done files appear when reviewers complete\n\n## Source\nPlan: ~/.claude/plans/unified-tinkering-token.md\nEpic: ai-configs-464","status":"in_progress","priority":1,"issue_type":"task","created_at":"2025-12-27T19:43:01.943469868Z","updated_at":"2025-12-27T20:04:11.765915087Z","dependencies":[{"issue_id":"ai-configs-464.1","depends_on_id":"ai-configs-464","type":"parent-child","created_at":"2025-12-27T19:43:01.950594517Z","created_by":"daemon"}]}
{"id":"ai-configs-464.2","title":"Create review-gate-check Stop hook script","description":"Single Stop hook that handles entire review gate lifecycle.\n\n## Primary Files\n- bin/review-gate-check (create)\n\n## Context\n- CRITICAL: Must allowlist review-gate-resolve command to prevent deadlock\n- Detects new artifacts and spawns reviewers if no active gate\n- Checks completion via sentinel files, calculates consensus\n- Outputs JSON to block stop with formatted results\n\n## Implementation Details\n\n### Allowlist (CRITICAL - prevents deadlock)\n```bash\nPENDING_CMD=$(echo \"$INPUT\" | jq -r \".pending_tool_input.command // \\\"\\\"\")\nif [[ \"$PENDING_CMD\" == *\"review-gate-resolve\"* ]]; then\n    exit 0  # Allow resolve command through\nfi\n```\n\n### JSON Parsing (handles markdown code fences)\n```bash\nextract_json() {\n    local file=\"$1\"\n    if jq -e . \"$file\" 2\u003e/dev/null; then\n        cat \"$file\"\n    else\n        sed -n \"/^\\`\\`\\`/,/^\\`\\`\\`/p\" \"$file\" | sed \"1d;\\$d\" | jq -e .\n    fi\n}\n```\n\n### Stale State Check\n- Delete and exit 0 if state is older than 1800 seconds (30 min)\n\n### Consensus Logic\n- Any FAIL → require user decision\n- NEEDS_WORK counts as \"not PASS\"\n- 3/3 PASS → auto-approve\n- 2/3 PASS with confidence ≥0.7 AND no FAIL → auto-approve\n\n## Acceptance Criteria\n- [ ] Exits 0 immediately if resolve command detected\n- [ ] Exits 0 if no .review/latest.md exists\n- [ ] Spawns reviewers if artifact exists but no state file\n- [ ] Reports progress if reviewers still running\n- [ ] Presents formatted results table when all complete\n- [ ] Handles stale state (\u003e30 min) by cleaning up\n- [ ] NEEDS_WORK and FAIL verdicts require user decision\n- [ ] Strips markdown code fences from JSON responses\n- [ ] Uses absolute paths\n\n## Test Plan\n- Test with no artifact → should exit 0\n- Test with artifact, no state → should spawn and block\n- Test with pending resolve command → should exit 0\n- Test consensus with PASS/PASS/PASS → auto-approve\n- Test consensus with PASS/PASS/FAIL → require decision\n\n## Source\nPlan: ~/.claude/plans/unified-tinkering-token.md\nEpic: ai-configs-464","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-27T19:43:18.514758493Z","updated_at":"2025-12-27T20:04:31.142816916Z","dependencies":[{"issue_id":"ai-configs-464.2","depends_on_id":"ai-configs-464","type":"parent-child","created_at":"2025-12-27T19:43:18.521703222Z","created_by":"daemon"},{"issue_id":"ai-configs-464.2","depends_on_id":"ai-configs-464.1","type":"blocks","created_at":"2025-12-27T19:43:25.261514363Z","created_by":"daemon"}]}
{"id":"ai-configs-464.3","title":"Create review-gate-resolve helper script","description":"Simple helper to mark gate as resolved.\n\n## Primary Files\n- bin/review-gate-resolve (create)\n\n## Context\n- Called by Claude after user decides PROCEED/REVISE/ABORT\n- Updates state file status to \"resolved\"\n- Must use absolute paths for state file location\n\n## Implementation\n```bash\n#!/bin/bash\n# Usage: review-gate-resolve \u003cproceed|revise|abort\u003e\n\nPROJECT_ROOT=\"${CLAUDE_PROJECT_DIR:-$(git rev-parse --show-toplevel 2\u003e/dev/null || pwd)}\"\nSTATE_FILE=\"$PROJECT_ROOT/.review/gate-state.json\"\n\nDECISION=\"${1:-proceed}\"\n\ncase \"$DECISION\" in\n    proceed|revise|abort) ;;\n    *) echo \"Invalid decision: $DECISION (use proceed, revise, or abort)\" \u003e\u00262; exit 1 ;;\nesac\n\nif [[ ! -f \"$STATE_FILE\" ]]; then\n    echo \"No active review gate\" \u003e\u00262\n    exit 0\nfi\n\nNOW=$(date -Iseconds)\njq --arg decision \"$DECISION\" --arg now \"$NOW\" \\\n    \".status = \\\"resolved\\\" | .decision = {action: \\$decision, decided_at: \\$now}\" \\\n    \"$STATE_FILE\" \u003e \"$STATE_FILE.tmp\" \u0026\u0026 mv \"$STATE_FILE.tmp\" \"$STATE_FILE\"\n\necho \"Review gate resolved: $DECISION\"\n```\n\n## Acceptance Criteria\n- [ ] Accepts decision argument: proceed, revise, or abort\n- [ ] Updates .review/gate-state.json status to \"resolved\"\n- [ ] Records decision action and timestamp\n- [ ] Validates decision argument\n- [ ] Handles missing state file gracefully\n\n## Test Plan\n- Run with valid decision → verify state updated\n- Run with invalid decision → verify error message\n- Run with no state file → verify graceful handling\n\n## Source\nPlan: ~/.claude/plans/unified-tinkering-token.md\nEpic: ai-configs-464","status":"in_progress","priority":2,"issue_type":"task","created_at":"2025-12-27T19:43:38.468202592Z","updated_at":"2025-12-27T20:04:45.959705234Z","dependencies":[{"issue_id":"ai-configs-464.3","depends_on_id":"ai-configs-464","type":"parent-child","created_at":"2025-12-27T19:43:38.474861283Z","created_by":"daemon"}]}
{"id":"ai-configs-464.4","title":"Create review-gate command","description":"$(cat /tmp/desc.txt)","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-27T19:43:54.867822234Z","updated_at":"2025-12-27T19:46:22.311051328Z","dependencies":[{"issue_id":"ai-configs-464.4","depends_on_id":"ai-configs-464","type":"parent-child","created_at":"2025-12-27T19:43:54.874554504Z","created_by":"daemon"},{"issue_id":"ai-configs-464.4","depends_on_id":"ai-configs-464.1","type":"blocks","created_at":"2025-12-27T19:44:01.088628831Z","created_by":"daemon"}]}
{"id":"ai-configs-464.5","title":"Update commands to write .review/latest.md","description":"$(cat /tmp/desc.txt)","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-27T19:44:14.748533186Z","updated_at":"2025-12-27T19:46:22.399988941Z","dependencies":[{"issue_id":"ai-configs-464.5","depends_on_id":"ai-configs-464","type":"parent-child","created_at":"2025-12-27T19:44:14.755726174Z","created_by":"daemon"}]}
{"id":"ai-configs-464.6","title":"Document Stop hook configuration","description":"$(cat /tmp/desc.txt)","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-27T19:44:28.919608686Z","updated_at":"2025-12-27T19:46:22.493291339Z","dependencies":[{"issue_id":"ai-configs-464.6","depends_on_id":"ai-configs-464","type":"parent-child","created_at":"2025-12-27T19:44:28.930436252Z","created_by":"daemon"},{"issue_id":"ai-configs-464.6","depends_on_id":"ai-configs-464.2","type":"blocks","created_at":"2025-12-27T19:44:35.279106782Z","created_by":"daemon"}]}
