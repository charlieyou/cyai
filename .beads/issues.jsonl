{"id":"ai-configs-464","title":"Epic: Multi-Model Review Gate System","description":"Implement ralph-wiggum pattern for multi-model review gates.\n\n## Overview\n- Automatically validates artifacts from /healthcheck, /architecture-review, /bd-breakdown\n- Spawns Claude, Codex, Gemini reviewers in parallel (read-only)\n- Blocks session stop until consensus or user decision\n- Manual trigger via /review-gate command\n\n## Architecture\nSingle Stop hook handles entire lifecycle:\n1. Allowlist resolve command (prevent deadlock)\n2. Detect artifact + spawn reviewers if needed\n3. Track completion via sentinel files\n4. Calculate consensus and present results\n5. Block until user decides PROCEED/REVISE/ABORT\n\n## Acceptance Criteria\n- Review gate can be triggered manually via /review-gate\n- Review gate automatically triggers when .review/latest.md exists\n- User can PROCEED/REVISE/ABORT after seeing consensus\n\n## Source\nPlan: ~/.claude/plans/unified-tinkering-token.md\nReviewed by: Codex, Gemini","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-27T19:42:45.007967311Z","updated_at":"2025-12-27T19:42:45.007967311Z"}
{"id":"ai-configs-464.1","title":"Create review-gate-spawn script","description":"Core script that spawns 3 reviewers (Claude, Codex, Gemini) in background.\n\n## Primary Files\n- bin/review-gate-spawn (create)\n\n## Context\n- Creates `.review/gate-state.json` with status tracking\n- Must use `nohup setsid` for process survival (critical fix from review)\n- Uses sentinel files (.done) instead of PIDs for completion tracking\n- Must handle absolute paths via $CLAUDE_PROJECT_DIR or git root\n\n## Implementation Details\n\nProcess survival pattern:\n```bash\nnohup setsid claude -p --allowedTools \"\" \"$PROMPT\" \u003e .review/reviews/claude.json 2\u003e\u00261 \u0026\n```\n\nSentinel file pattern:\n```bash\n(claude ... \u003e .review/reviews/claude.json \u0026\u0026 touch .review/reviews/claude.done) \u0026\n```\n\nPath resolution:\n```bash\nPROJECT_ROOT=\"${CLAUDE_PROJECT_DIR:-$(git rev-parse --show-toplevel 2\u003e/dev/null || pwd)}\"\n```\n\nPreflight check - required: jq, claude; optional: codex, gemini (warn and skip if missing)\n\n## Acceptance Criteria\n- [ ] Script accepts artifact path as argument\n- [ ] Creates .review/reviews/ directory\n- [ ] Spawns available reviewers (skip missing CLIs with warning)\n- [ ] Creates gate-state.json with created_at timestamp\n- [ ] Background processes survive script exit\n- [ ] .done sentinel files created on completion\n- [ ] Cleans up old state at start\n\n## Test Plan\n- Run `./bin/review-gate-spawn test.md` manually\n- Verify .review/gate-state.json created with correct schema\n- Verify reviewer processes run in background\n- Verify .done files appear when reviewers complete\n\n## Source\nPlan: ~/.claude/plans/unified-tinkering-token.md\nEpic: ai-configs-464","notes":"Quality gate failed: Codex review failed: bin/review-gate-spawn:260: Gate state stores reviewer PIDs (`pid` field) even though scope requires completion tracking via `.done` sentinels instead of PIDs; drop PID tracking or make sentinels the only completion signal.\nLog: /home/cyou/.claude/projects/-home-cyou-ai-configs/4f9235ef-c3f0-4d3c-a80e-e643c3ca4be6.jsonl","status":"in_progress","priority":1,"issue_type":"task","created_at":"2025-12-27T19:43:01.943469868Z","updated_at":"2025-12-27T22:10:11.816565483Z","labels":["needs-followup"],"dependencies":[{"issue_id":"ai-configs-464.1","depends_on_id":"ai-configs-464","type":"parent-child","created_at":"2025-12-27T19:43:01.950594517Z","created_by":"daemon"}]}
{"id":"ai-configs-464.2","title":"Create review-gate-check Stop hook script","description":"Single Stop hook that handles entire review gate lifecycle.\n\n## Primary Files\n- bin/review-gate-check (create)\n\n## Context\n- CRITICAL: Must allowlist review-gate-resolve command to prevent deadlock\n- Detects new artifacts and spawns reviewers if no active gate\n- Checks completion via sentinel files, calculates consensus\n- Outputs JSON to block stop with formatted results\n\n## Implementation Details\n\n### Allowlist (CRITICAL - prevents deadlock)\n```bash\nPENDING_CMD=$(echo \"$INPUT\" | jq -r \".pending_tool_input.command // \\\"\\\"\")\nif [[ \"$PENDING_CMD\" == *\"review-gate-resolve\"* ]]; then\n    exit 0  # Allow resolve command through\nfi\n```\n\n### JSON Parsing (handles markdown code fences)\n```bash\nextract_json() {\n    local file=\"$1\"\n    if jq -e . \"$file\" 2\u003e/dev/null; then\n        cat \"$file\"\n    else\n        sed -n \"/^\\`\\`\\`/,/^\\`\\`\\`/p\" \"$file\" | sed \"1d;\\$d\" | jq -e .\n    fi\n}\n```\n\n### Stale State Check\n- Delete and exit 0 if state is older than 1800 seconds (30 min)\n\n### Consensus Logic\n- Any FAIL → require user decision\n- NEEDS_WORK counts as \"not PASS\"\n- 3/3 PASS → auto-approve\n- 2/3 PASS with confidence ≥0.7 AND no FAIL → auto-approve\n\n## Acceptance Criteria\n- [ ] Exits 0 immediately if resolve command detected\n- [ ] Exits 0 if no .review/latest.md exists\n- [ ] Spawns reviewers if artifact exists but no state file\n- [ ] Reports progress if reviewers still running\n- [ ] Presents formatted results table when all complete\n- [ ] Handles stale state (\u003e30 min) by cleaning up\n- [ ] NEEDS_WORK and FAIL verdicts require user decision\n- [ ] Strips markdown code fences from JSON responses\n- [ ] Uses absolute paths\n\n## Test Plan\n- Test with no artifact → should exit 0\n- Test with artifact, no state → should spawn and block\n- Test with pending resolve command → should exit 0\n- Test consensus with PASS/PASS/PASS → auto-approve\n- Test consensus with PASS/PASS/FAIL → require decision\n\n## Source\nPlan: ~/.claude/plans/unified-tinkering-token.md\nEpic: ai-configs-464","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-27T19:43:18.514758493Z","updated_at":"2025-12-27T20:04:31.142816916Z","dependencies":[{"issue_id":"ai-configs-464.2","depends_on_id":"ai-configs-464","type":"parent-child","created_at":"2025-12-27T19:43:18.521703222Z","created_by":"daemon"},{"issue_id":"ai-configs-464.2","depends_on_id":"ai-configs-464.1","type":"blocks","created_at":"2025-12-27T19:43:25.261514363Z","created_by":"daemon"}]}
{"id":"ai-configs-464.3","title":"Create review-gate-resolve helper script","description":"Simple helper to mark gate as resolved.\n\n## Primary Files\n- bin/review-gate-resolve (create)\n\n## Context\n- Called by Claude after user decides PROCEED/REVISE/ABORT\n- Updates state file status to \"resolved\"\n- Must use absolute paths for state file location\n\n## Implementation\n```bash\n#!/bin/bash\n# Usage: review-gate-resolve \u003cproceed|revise|abort\u003e\n\nPROJECT_ROOT=\"${CLAUDE_PROJECT_DIR:-$(git rev-parse --show-toplevel 2\u003e/dev/null || pwd)}\"\nSTATE_FILE=\"$PROJECT_ROOT/.review/gate-state.json\"\n\nDECISION=\"${1:-proceed}\"\n\ncase \"$DECISION\" in\n    proceed|revise|abort) ;;\n    *) echo \"Invalid decision: $DECISION (use proceed, revise, or abort)\" \u003e\u00262; exit 1 ;;\nesac\n\nif [[ ! -f \"$STATE_FILE\" ]]; then\n    echo \"No active review gate\" \u003e\u00262\n    exit 0\nfi\n\nNOW=$(date -Iseconds)\njq --arg decision \"$DECISION\" --arg now \"$NOW\" \\\n    \".status = \\\"resolved\\\" | .decision = {action: \\$decision, decided_at: \\$now}\" \\\n    \"$STATE_FILE\" \u003e \"$STATE_FILE.tmp\" \u0026\u0026 mv \"$STATE_FILE.tmp\" \"$STATE_FILE\"\n\necho \"Review gate resolved: $DECISION\"\n```\n\n## Acceptance Criteria\n- [ ] Accepts decision argument: proceed, revise, or abort\n- [ ] Updates .review/gate-state.json status to \"resolved\"\n- [ ] Records decision action and timestamp\n- [ ] Validates decision argument\n- [ ] Handles missing state file gracefully\n\n## Test Plan\n- Run with valid decision → verify state updated\n- Run with invalid decision → verify error message\n- Run with no state file → verify graceful handling\n\n## Source\nPlan: ~/.claude/plans/unified-tinkering-token.md\nEpic: ai-configs-464","notes":"Quality gate failed: Quality gate failed: Missing validation commands: uv sync\nLog: /home/cyou/.claude/projects/-home-cyou-ai-configs/a59e44ae-e122-4678-b984-8913d419f445.jsonl","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T19:43:38.468202592Z","updated_at":"2025-12-27T21:22:55.645992943Z","closed_at":"2025-12-27T21:22:55.645992943Z","close_reason":"Closed","labels":["needs-followup"],"dependencies":[{"issue_id":"ai-configs-464.3","depends_on_id":"ai-configs-464","type":"parent-child","created_at":"2025-12-27T19:43:38.474861283Z","created_by":"daemon"}]}
{"id":"ai-configs-464.4","title":"Create review-gate command","description":"Manual trigger command for review gate.\n\n## Primary Files\n- commands/review-gate.md (create)\n\n## Context\n- Allows user to manually trigger review gate on any artifact\n- Instructs Claude to run spawn script via Bash tool\n- Documents PROCEED/REVISE/ABORT workflow\n\n## Implementation\n```markdown\n---\ndescription: Multi-model consensus review with user approval gate\nargument-hint: \u003cartifact-path\u003e\n---\n\n# Review Gate\n\nRun multi-model consensus review on an artifact. Three reviewers (Claude, Codex, Gemini) analyze the artifact in parallel, then present results for your decision.\n\n## Usage\n\n/review-gate path/to/artifact.md\n\n## Workflow\n\n### 1. Trigger Review\n\nRun the spawn script to start parallel reviews:\n\n```bash\n~/.local/bin/review-gate-spawn \"$ARGUMENTS\"\n```\n\n### 2. Wait for Results\n\nThe Stop hook will automatically:\n- Check reviewer completion\n- Calculate consensus\n- Present results table\n\n### 3. Decide\n\nRespond with one of:\n- **PROCEED** - Continue to next stage\n- **REVISE** - Address issues, re-run later\n- **ABORT** - Stop the workflow\n\n### 4. Resolve\n\nAfter deciding, run:\n\n```bash\n~/.local/bin/review-gate-resolve \u003cdecision\u003e\n```\n```\n\n## Acceptance Criteria\n- [ ] YAML frontmatter with description and argument-hint\n- [ ] Clear workflow steps for manual triggering\n- [ ] Documents decision options\n- [ ] Instructs use of Bash tool to run spawn script\n\n## Test Plan\n- Verify command appears in /help output\n- Verify /review-gate \u003cpath\u003e triggers spawn correctly\n\n## Source\nPlan: ~/.claude/plans/unified-tinkering-token.md\nEpic: ai-configs-464","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-27T19:43:54.867822234Z","updated_at":"2025-12-27T20:04:59.872735918Z","dependencies":[{"issue_id":"ai-configs-464.4","depends_on_id":"ai-configs-464","type":"parent-child","created_at":"2025-12-27T19:43:54.874554504Z","created_by":"daemon"},{"issue_id":"ai-configs-464.4","depends_on_id":"ai-configs-464.1","type":"blocks","created_at":"2025-12-27T19:44:01.088628831Z","created_by":"daemon"}]}
{"id":"ai-configs-464.5","title":"Update commands to write .review/latest.md","description":"Commands must explicitly write output to .review/latest.md for review gate to work.\n\n## Primary Files\n- commands/healthcheck.md (modify)\n- commands/architecture-review.md (modify)\n\n## Context\n- Adding markdown instruction alone does not execute - must instruct Write tool usage\n- Review gate detects .review/latest.md to trigger automatically\n- Both commands need identical \"Final Step\" section\n\n## Implementation\n\nAdd to end of each command file:\n\n```markdown\n---\n\n## Final Step\n\nAfter completing the review, use the Write tool to save this entire review output to `.review/latest.md`:\n\n```\nWrite the complete review above to .review/latest.md\n```\n\nThis enables automatic review gate validation if configured.\n```\n\n## Acceptance Criteria\n- [ ] healthcheck.md has final step instructing Write tool\n- [ ] architecture-review.md has same instruction\n- [ ] Instructions are clear and actionable\n- [ ] Existing command content is preserved\n\n## Test Plan\n- Run /healthcheck → verify .review/latest.md is created\n- Run /architecture-review → verify .review/latest.md is created\n\n## Notes\n- Do NOT modify bd-breakdown - it creates issues, not reviewable markdown artifacts\n\n## Source\nPlan: ~/.claude/plans/unified-tinkering-token.md\nEpic: ai-configs-464","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T19:44:14.748533186Z","updated_at":"2025-12-27T20:27:01.080801893Z","closed_at":"2025-12-27T20:27:01.080801893Z","close_reason":"Closed","dependencies":[{"issue_id":"ai-configs-464.5","depends_on_id":"ai-configs-464","type":"parent-child","created_at":"2025-12-27T19:44:14.755726174Z","created_by":"daemon"}]}
{"id":"ai-configs-464.6","title":"Document Stop hook configuration","description":"Document the hook configuration for ~/.claude/settings.json.\n\n## Primary Files\n- Documentation only (user's ~/.claude/settings.json is manual step)\n\n## Context\n- Hook configuration must be merged into existing settings.json\n- Only Stop hook needed (revised architecture from Codex/Gemini review)\n- User must manually add or merge the config\n- Cannot modify user's settings file directly\n\n## Hook Configuration\n\nAdd to ~/.claude/settings.json:\n\n```json\n{\n  \"hooks\": {\n    \"Stop\": [\n      {\n        \"hooks\": [{\n          \"type\": \"command\",\n          \"command\": \"~/.local/bin/review-gate-check\",\n          \"timeout\": 60\n        }]\n      }\n    ]\n  }\n}\n```\n\n## Merge Instructions\n\nIf you already have a \"hooks\" key in settings.json, add the Stop array to it:\n\n```json\n{\n  \"hooks\": {\n    \"ExistingHook\": [...],\n    \"Stop\": [\n      {\n        \"hooks\": [{\n          \"type\": \"command\", \n          \"command\": \"~/.local/bin/review-gate-check\",\n          \"timeout\": 60\n        }]\n      }\n    ]\n  }\n}\n```\n\n## Acceptance Criteria\n- [ ] Clear JSON snippet for hooks configuration\n- [ ] Instructions for merging with existing settings\n- [ ] Timeout set to 60s (sufficient for check script)\n- [ ] Only Stop hook (no PostToolUse per revised architecture)\n\n## Test Plan\n- After config added, start new Claude session\n- Run /healthcheck → verify review gate triggers\n- Verify PROCEED/REVISE/ABORT flow works\n\n## Notes\n- This is a documentation/instruction task\n- User applies changes manually to their settings.json\n\n## Source\nPlan: ~/.claude/plans/unified-tinkering-token.md\nEpic: ai-configs-464","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-27T19:44:28.919608686Z","updated_at":"2025-12-27T20:05:24.426705873Z","dependencies":[{"issue_id":"ai-configs-464.6","depends_on_id":"ai-configs-464","type":"parent-child","created_at":"2025-12-27T19:44:28.930436252Z","created_by":"daemon"},{"issue_id":"ai-configs-464.6","depends_on_id":"ai-configs-464.2","type":"blocks","created_at":"2025-12-27T19:44:35.279106782Z","created_by":"daemon"}]}
