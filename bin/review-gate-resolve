#!/usr/bin/env bash
# review-gate-resolve - Mark the review gate as resolved with a decision
#
# Usage: review-gate-resolve <proceed|revise|abort>
#
# Updates the session-scoped gate-state.json to mark the gate as resolved,
# allowing the Stop hook to permit session termination.
#
# Acceptance criteria:
# - Accepts decision argument: proceed, revise, or abort
# - Updates session-scoped gate-state.json status to "resolved"
# - Records decision action and timestamp
# - Validates decision argument
# - Handles missing state file gracefully (exits 0)

set -euo pipefail

# Resolve helper scripts relative to this file (works when symlinked)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source shared library
source "$SCRIPT_DIR/review-gate-lib.sh"

# Validate argument
if [[ $# -lt 1 ]]; then
    echo "Usage: review-gate-resolve <proceed|revise|abort>" >&2
    exit 1
fi

DECISION="$1"

# Validate decision value
case "$DECISION" in
    proceed|revise|abort)
        ;;
    *)
        echo "Error: Invalid decision '$DECISION'. Must be: proceed, revise, or abort" >&2
        exit 1
        ;;
esac

# --- Session-scoped path resolution ---
SESSION_ID="${REVIEW_GATE_SESSION_ID:-}"
TRANSCRIPT_PATH="${REVIEW_GATE_TRANSCRIPT_PATH:-}"

if [[ -n "$SESSION_ID" ]]; then
    # Session context available - use session-scoped path
    REVIEW_DIR=$(resolve_review_dir "$SESSION_ID" "$TRANSCRIPT_PATH")
    STATE_FILE="$REVIEW_DIR/gate-state.json"
else
    # No session context - try to find active gate in project
    ACTIVE_SESSION=$(find_active_gate "$TRANSCRIPT_PATH" 2>/dev/null || echo "")
    if [[ -n "$ACTIVE_SESSION" ]]; then
        BASE_DIR=$(get_review_base_dir "$TRANSCRIPT_PATH")
        STATE_FILE="$BASE_DIR/$ACTIVE_SESSION/gate-state.json"
    else
        echo "No active review gate found" >&2
        exit 0
    fi
fi

# Check if state file exists
if [[ ! -f "$STATE_FILE" ]]; then
    echo "No active review gate" >&2
    exit 0
fi

# Check for jq dependency
if ! command -v jq >/dev/null 2>&1; then
    echo "Error: jq is required but not installed" >&2
    exit 1
fi

# Get current timestamp in ISO 8601 format
TIMESTAMP=$(date -Iseconds)

# Update state file atomically
TEMP_FILE="${STATE_FILE}.tmp.$$"
trap 'rm -f "$TEMP_FILE"' EXIT

jq --arg decision "$DECISION" \
   --arg timestamp "$TIMESTAMP" \
   '.status = "resolved" | .decision.action = $decision | .decision.decided_at = $timestamp' \
   "$STATE_FILE" > "$TEMP_FILE"

# Validate the output is valid JSON
if ! jq -e . "$TEMP_FILE" >/dev/null 2>&1; then
    echo "Error: Failed to create valid JSON output" >&2
    exit 1
fi

mv "$TEMP_FILE" "$STATE_FILE"

echo "Review gate resolved: $DECISION"
