#!/usr/bin/env bash
# review-gate-resolve - Mark the review gate as resolved with a decision
#
# Usage: review-gate-resolve <proceed|revise|abort>
#
# Updates .review/gate-state.json to mark the gate as resolved,
# allowing the Stop hook to permit session termination.
#
# Acceptance criteria:
# - Accepts decision argument: proceed, revise, or abort
# - Updates .review/gate-state.json status to "resolved"
# - Records decision action and timestamp
# - Validates decision argument
# - Handles missing state file gracefully (exits 0)

set -euo pipefail

# Validate argument
if [[ $# -lt 1 ]]; then
    echo "Usage: review-gate-resolve <proceed|revise|abort>" >&2
    exit 1
fi

DECISION="$1"

# Validate decision value
case "$DECISION" in
    proceed|revise|abort)
        ;;
    *)
        echo "Error: Invalid decision '$DECISION'. Must be: proceed, revise, or abort" >&2
        exit 1
        ;;
esac

# Determine project root (use CLAUDE_PROJECT_DIR if set, otherwise git root)
PROJECT_ROOT="${CLAUDE_PROJECT_DIR:-$(git rev-parse --show-toplevel 2>/dev/null || pwd)}"
STATE_FILE="$PROJECT_ROOT/.review/gate-state.json"

# Check if state file exists
if [[ ! -f "$STATE_FILE" ]]; then
    echo "No active review gate" >&2
    exit 0
fi

# Check for jq dependency
if ! command -v jq >/dev/null 2>&1; then
    echo "Error: jq is required but not installed" >&2
    exit 1
fi

# Get current timestamp in ISO 8601 format
TIMESTAMP=$(date -Iseconds)

# Update state file atomically
TEMP_FILE="${STATE_FILE}.tmp.$$"
trap 'rm -f "$TEMP_FILE"' EXIT

jq --arg decision "$DECISION" \
   --arg timestamp "$TIMESTAMP" \
   '.status = "resolved" | .decision.action = $decision | .decision.decided_at = $timestamp' \
   "$STATE_FILE" > "$TEMP_FILE"

# Validate the output is valid JSON
if ! jq -e . "$TEMP_FILE" >/dev/null 2>&1; then
    echo "Error: Failed to create valid JSON output" >&2
    exit 1
fi

mv "$TEMP_FILE" "$STATE_FILE"

echo "Review gate resolved: $DECISION"
