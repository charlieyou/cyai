#!/usr/bin/env bash
# Auto-bootstrapping wrapper for layers.py
# Creates venv and installs deps if needed

SCRIPT_PATH="$(python3 - <<'PY' "${BASH_SOURCE[0]}"
import os
import sys
print(os.path.realpath(sys.argv[1]))
PY
)"
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

if [[ -n "${AI_CONFIGS_DIR:-}" ]]; then
    ROOT_DIR="$AI_CONFIGS_DIR"
fi

SKILL_DIR="$ROOT_DIR/skills/grimp-architecture"

if [[ ! -d "$SKILL_DIR" ]]; then
    FALLBACK_DIR="$HOME/ai-configs"
    if [[ -d "$FALLBACK_DIR/skills/grimp-architecture" ]]; then
        ROOT_DIR="$FALLBACK_DIR"
        SKILL_DIR="$ROOT_DIR/skills/grimp-architecture"
    fi
fi

if [[ ! -d "$SKILL_DIR" ]]; then
    echo "Could not find grimp-architecture skill directory." >&2
    echo "Set AI_CONFIGS_DIR to the ai-configs repo root." >&2
    exit 2
fi

VENV_DIR="$SKILL_DIR/.venv"
PYTHON="$VENV_DIR/bin/python"
SCRIPT="$SKILL_DIR/scripts/layers.py"

# Bootstrap venv if missing
if [[ ! -f "$PYTHON" ]]; then
    echo "Bootstrapping venv..." >&2
    uv venv "$VENV_DIR" --quiet 2>/dev/null || python3 -m venv "$VENV_DIR"
fi

# Ensure pip is available
if ! "$PYTHON" -m pip --version >/dev/null 2>&1; then
    "$PYTHON" -m ensurepip --upgrade >/dev/null 2>&1 || true
fi

# Ensure grimp is installed in the venv
if ! "$PYTHON" - <<'PY' >/dev/null 2>&1
import grimp  # noqa: F401
PY
then
    "$PYTHON" -m pip install -q grimp
fi

exec "$PYTHON" "$SCRIPT" "$@"
